language: node_js

node_js:
  - 6.7.0

services:
  - postgres

env:
  PORT=10010
  POSTGRES_HOST=127.0.0.1
  POSTGRES_DB=ci
  POSTGRES_USER=ci
  POSTGRES_PWD=ci
  CODECOV_TOKEN=92837d5d-c380-4814-ba8f-aca3bf099b4f
  DOCKER_REPO=599844260227.dkr.ecr.us-east-1.amazonaws.com/service-boilerplate
  DOCKER_TAG=$BRANCH-$COMMIT


build:
  ci:
    - psql -c "create user ci with superuser password 'ci';" -U postgres
    - psql -c "create database ci;" -U postgres
    - docker build --rm=false -t $DOCKER_REPO:$DOCKER_TAG .
    - ./node_modules/.bin/nyc ./node_modules/.bin/ava --tap | ./node_modules/.bin/tap-xunit > shippable/testresults/results.xml
    - ./node_modules/.bin/nyc report --reporter=cobertura --report-dir ./shippable/codecoverage
    - bash <(curl -s https://codecov.io/bash)
  push:
      docker push $DOCKER_REPO:$DOCKER_TAG

integrations:
  hub:
    - integrationName: ecr-integration
      type: ecr
      branches:
        only:
          - master