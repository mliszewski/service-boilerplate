language: node_js

node_js:
  - 6.7.0

env:
  global:
    - secure: MlfAO2aPiVe1XFZsnG4EwC7HIHsIzz4CD0s7mQ7P2y4kjMA5y9a9Lp4tqaxjZvZoozNTv90zChtNdh+C1zDBWZQBdope1AAhcVIHwHZ+ebxR0loWBhOPGQcA1EEqXJe7v+l5cDT9wcNZKLRAalymCSvSBNxh+aewUbBE5cKiOW2vz6dTwh/rEugMsUhmqB9HXSZdhm57HNATOPmX0tXBBft/vjJkfRa4njEtDumuLR/zuoPJajVzlttUxhxt7HjxnJOHJaQcAzbnvX9qqIZjsehpVvMRdGoiK1EYi+grrdO9ugetv1h/cL7AdPt/t6UXznI8wZfICy7ieh79dDVGHg==
    - PORT=10010
    - CODECOV_TOKEN=92837d5d-c380-4814-ba8f-aca3bf099b4f
    - DOCKER_REPO=599844260227.dkr.ecr.us-east-1.amazonaws.com/service-boilerplate
    - DOCKER_TAG=$BRANCH-$COMMIT
    - POSTGRES_DB=test_$JOB_ID


build:
  ci:
    - docker build --rm=false --build-arg POSTGRES_DB=$POSTGRES_DB --build-arg POSTGRES_HOST=$POSTGRES_HOST --build-arg POSTGRES_USER=$POSTGRES_USER --build-arg POSTGRES_PWD=$POSTGRES_PWD  -t $DOCKER_REPO:$DOCKER_TAG .
    - docker stop service-boilerplate || docker rm service-boilerplate || docker run -d -p 8080:10010 -e PORT -e POSTGRES_HOST -e POSTGRES_DB -e POSTGRES_USER --name service-boilerplate $DOCKER_REPO:$DOCKER_TAG; sleep 10
    - docker cp service-boilerplate:results/results.xml ./shippable/testresults/results.xml
    - docker cp service-boilerplate:results/codecoverage/. ./shippable/codecoverage/
    - docker stop service-boilerplate && docker rm service-boilerplate
    - bash <(curl -s https://codecov.io/bash)
  push:
      docker push $DOCKER_REPO:$DOCKER_TAG

integrations:
  hub:
    - integrationName: ecr-integration
      type: ecr
      branches:
        only:
          - master

notifications:
  - integrationName: boilerplate-staging
    type: webhook
    payload:
      - versionName=$DOCKER_TAG
    on_success: always
    on_failure: never